tags:
  - name: racephases
    description: Gestion des phases d’une compétition (Séries, Demi-finales, Finales, etc.)

paths:
  /race-phases:
    post:
      tags: [racephases]
      summary: Créer une phase de course
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [event_id, name, order_index]
              properties:
                event_id:
                  type: string
                name:
                  type: string
                order_index:
                  type: integer
      responses:
        201:
          description: Phase créée

  /race-phases/{event_id}:
    get:
      tags: [racephases]
      summary: Récupérer les phases d’un événement
      parameters:
        - in: path
          name: event_id
          required: true
          schema:
            type: string
      responses:
        200:
          description: Liste des phases triée par ordre

  /race-phases/{id}:
    put:
      tags: [racephases]
      summary: Modifier une phase
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                order_index:
                  type: integer
      responses:
        200:
          description: Phase mise à jour

    delete:
      tags: [racephases]
      summary: Supprimer une phase
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        200:
          description: Phase supprimée

  /race-phases/{id}/generate-from-schema:
    post:
      tags: [racephases]
      summary: Générer les courses depuis le schéma enregistré
      description: |
        Génère les courses à partir du schéma de génération enregistré pour cette phase.
        Le schéma doit avoir été préalablement enregistré via POST /races/generate-from-series avec save_only=true
        ou lors d'une génération précédente.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la phase
      responses:
        200:
          description: Courses générées avec succès depuis le schéma enregistré
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: "3 courses générées avec succès depuis le schéma enregistré"
                  data:
                    type: object
                    properties:
                      races_created:
                        type: integer
                      crews_assigned:
                        type: integer
                      races:
                        type: array
                        items:
                          type: object
                      generation_schema:
                        type: object
        400:
          description: Aucun schéma enregistré ou schéma invalide
        404:
          description: Phase introuvable

  /race-phases/{id}/generation-schema:
    get:
      tags: [racephases]
      summary: Récupérer le schéma de génération des courses d'une phase
      description: |
        Récupère le schéma JSON utilisé pour générer les courses depuis les séries.
        Ce schéma est automatiquement enregistré lors de l'appel à POST /races/generate-from-series.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la phase
      responses:
        200:
          description: Schéma de génération récupéré avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  data:
                    type: object
                    properties:
                      phase_id:
                        type: string
                        format: uuid
                      phase_name:
                        type: string
                      generation_schema:
                        type: object
                        nullable: true
                        properties:
                          lane_count:
                            type: integer
                          start_time:
                            type: string
                            format: date-time
                            nullable: true
                          interval_minutes:
                            type: integer
                          series:
                            type: array
                            items:
                              type: object
                              properties:
                                id:
                                  type: string
                                categories:
                                  type: object
                                  additionalProperties:
                                    type: integer
                          generated_at:
                            type: string
                            format: date-time
                          updated_at:
                            type: string
                            format: date-time
        404:
          description: Phase introuvable

    put:
      tags: [racephases]
      summary: Mettre à jour le schéma de génération des courses d'une phase
      description: |
        Met à jour le schéma JSON utilisé pour générer les courses depuis les séries.
        Ce schéma peut être utilisé pour pré-remplir le formulaire de génération ou pour réappliquer la même configuration.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: ID de la phase
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [generation_schema]
              properties:
                generation_schema:
                  type: object
                  required: [lane_count, series]
                  properties:
                    lane_count:
                      type: integer
                      minimum: 1
                      description: Nombre de lignes d'eau disponibles
                    start_time:
                      type: string
                      format: date-time
                      nullable: true
                      description: Heure de départ de la première course
                    interval_minutes:
                      type: integer
                      minimum: 0
                      description: Minutes entre chaque course
                    series:
                      type: array
                      minItems: 1
                      items:
                        type: object
                        required: [id, categories]
                        properties:
                          id:
                            type: string
                            description: Identifiant unique de la série
                          categories:
                            type: object
                            additionalProperties:
                              type: integer
                              minimum: 1
                            description: Objet avec codes de catégories comme clés et nombre d'équipages comme valeurs
      responses:
        200:
          description: Schéma de génération mis à jour avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: "Schéma de génération mis à jour avec succès"
                  data:
                    type: object
                    properties:
                      phase_id:
                        type: string
                        format: uuid
                      phase_name:
                        type: string
                      generation_schema:
                        type: object
        400:
          description: Paramètres invalides
        404:
          description: Phase introuvable

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
