tags:
  - name: races
    description: Gestion des courses (configuration, phases, distances...)

paths:
  /races:
    get:
      tags: [races]
      summary: Liste des courses
      responses:
        200:
          description: Liste renvoyée

    post:
      tags: [races]
      summary: Créer une course
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phase_id]
              properties:
                phase_id:
                  type: string
                name:
                  type: string
                race_type:
                  type: string
                lane_count:
                  type: integer
                  minimum: 1
                race_number:
                  type: integer
                distance_id:
                  type: string
                status:
                  type: string
                  enum:
                    - not_started
                    - non_official
                    - official
                    - in_progress
                    - delayed
                    - cancelled
                    - finished
                start_time:
                  type: string
                  format: date-time
      responses:
        201:
          description: Course créée

  /races/event/{event_id}:
    get:
      tags: [races]
      summary: Liste des courses d’un événement
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: event_id
          required: true
          schema:
            type: string
          description: ID de l’événement
      responses:
        200:
          description: Liste des courses associées à l’événement

  /races/generate:
    post:
      tags: [races]
      summary: Génère les courses et affecte les équipages
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phase_id, lane_count]
              properties:
                phase_id:
                  type: string
                  format: uuid
                lane_count:
                  type: integer
                  minimum: 1
                start_time:
                  type: string
                  format: date-time
                  description: Heure de départ de la première course
                interval_minutes:
                  type: integer
                  minimum: 0
                  description: Minutes entre chaque course
                category_order:
                  type: array
                  items:
                    type: string
                  description: |
                    Ordre personnalisé des catégories (tableau de codes de catégories).
                    Les catégories seront traitées dans cet ordre lors de la génération des courses.
                    Les catégories non listées seront ajoutées à la fin (triées par code).
                    Exemple: ["H4X", "H2X", "F4X", "F2X", "H1X", "F1X"]
                  example: ["H4X", "H2X", "F4X", "F2X"]
      responses:
        200:
          description: Courses générées

  /races/generate-from-series:
    post:
      tags: [races]
      summary: Génère les courses à partir de séries prédéfinies
      description: |
        Génère les courses en respectant la structure des séries fournie par le frontend.
        Chaque série devient une course avec les équipages assignés selon le nombre spécifié par catégorie.
        Les équipages sont sélectionnés aléatoirement parmi ceux disponibles pour chaque catégorie.
        
        **Mode brouillon** : Utilisez `save_only: true` pour enregistrer uniquement le schéma sans générer les courses.
        Vous pourrez ensuite générer les courses via `POST /race-phases/:id/generate-from-schema`.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phase_id, lane_count, series]
              properties:
                phase_id:
                  type: string
                  format: uuid
                lane_count:
                  type: integer
                  minimum: 1
                start_time:
                  type: string
                  format: date-time
                  description: Heure de départ de la première course (optionnel)
                interval_minutes:
                  type: integer
                  minimum: 0
                  default: 5
                  description: Minutes entre chaque course (optionnel)
                series:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [id, categories]
                    properties:
                      id:
                        type: string
                        description: Identifiant unique de la série
                      categories:
                        type: object
                        additionalProperties:
                          type: integer
                          minimum: 1
                        description: |
                          Objet avec les codes de catégories comme clés et le nombre d'équipages comme valeurs.
                          Exemple: { "SF": 5, "SH": 1 } signifie 5 équipages "Senior Femme" et 1 "Senior Homme"
                  example:
                    - id: "series-1234567890"
                      categories:
                        SF: 5
                        SH: 1
                    - id: "series-1234567891"
                      categories:
                        SF: 5
                        SH: 1
                    - id: "series-1234567892"
                      categories:
                        JF: 6
                save_only:
                  type: boolean
                  default: false
                  description: |
                    Si true, enregistre uniquement le schéma sans générer les courses (mode brouillon).
                    Vous pourrez ensuite générer les courses via POST /race-phases/:id/generate-from-schema.
      responses:
        200:
          description: Courses générées avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: "5 courses générées avec succès"
                  data:
                    type: object
                    properties:
                      races_created:
                        type: integer
                        description: Nombre de courses créées
                      crews_assigned:
                        type: integer
                        description: Nombre total d'équipages assignés
                      races:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                            race_number:
                              type: integer
                            start_time:
                              type: string
                              format: date-time
                            distance_id:
                              type: string
                              nullable: true
                            crews_count:
                              type: integer
        400:
          description: Erreurs de validation
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: "Erreurs de validation"
                  errors:
                    type: array
                    items:
                      type: string
                    example:
                      - "Série 1: Le nombre total de participants (7) dépasse le nombre de lignes d'eau (6)"
                      - "Série 2: Les catégories ont des distances différentes"

  /races/{id}:
    get:
      tags: [races]
      summary: Obtenir une course par ID
      parameters:
        - in: path
          name: id
          schema:
            type: string
          required: true
      responses:
        200:
          description: Détail de la course
        404:
          description: Non trouvée

    put:
      tags: [races]
      summary: Modifier une course
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema:
            type: string
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phase_id:
                  type: string
                name:
                  type: string
                race_type:
                  type: string
                lane_count:
                  type: integer
                  minimum: 1
                race_number:
                  type: integer
                distance_id:
                  type: string
      responses:
        200:
          description: Course mise à jour

    delete:
      tags: [races]
      summary: Supprimer une course
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema:
            type: string
          required: true
      responses:
        200:
          description: Course supprimée

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
